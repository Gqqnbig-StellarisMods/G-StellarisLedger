@*支持页面基础部分的本地化，字符串由Resources\View文件夹里的文件提供*@
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Lo
@*支持群星游戏字符串的本地化，字符串由游戏的YAML文件提供*@
@inject YamlStringLocalizer YLo

@model StellarisLedger.Models.PlanetsIndexViewModel

@{
	ViewData["Title"] = YLo["PLANETS"];
}

@section head
{
	<style type="text/css">
		.nonexistent {
			background-color: lightgray;
			cursor: not-allowed;
		}

		.tiles {
			margin-bottom: 2em;
			table-layout: fixed;
		}

		table.tiles caption {
			caption-side: top;
		}

		.tiles td {
			text-align: center;
			height: 2em;
			width: 20%;
		}

		.tiles .resource {
			margin: 0.1em 0.2em;
		}

		.bg-highlight {
			border: 3px dotted orange !important;
		}

		.bg-active {
			border: 3px dotted lightblue !important;
		}

		.allowNeuroElectricAmplifierLabel[disabled] {
			color: gray;
		}
		.allowNeuroElectricAmplifierLabel[disabled]::after {
			content: "@Lo["({0} requires {1})", YLo["building_neuro_electric_amplifier"], YLo["building_capital_2"]]";
			margin-left: 1em;
		}
	</style>
}
@if (Model.IsMachineEmpire)
{
	<p class="bg-info text-light">
		@Lo["Options have been optimized for {0} that you are playing.", YLo["machine_intelligence"]]
	</p>
}
<div id="planets">
	<div class="d-none">
		<fieldset class="planet" id="planetSectionTemplate">
			<legend></legend>

			<div class="container-fluid">
				<div class="row">
					<div class="col-md">
						<table class='table-bordered tiles'></table>
					</div>
					<div class="best-colony col-md">
						<label>@Lo["Adjacency Bonus"]</label>
						<select class="adjacency-bonus-input">
							<option value="1">1 - @YLo["building_capital_1"]</option>
							<option value="2">2 - @YLo["building_capital_2"]</option>
							<option value="3">3 - @YLo["building_capital_3"]</option>
						</select>

						<label class="form-check" style="padding-left: 0"><input class="not-on-special-input" type="checkbox" />@Lo["Do not build on special resources"]</label>
						@if (Model.IsMachineEmpire)
						{
							<label class="form-check allowNeuroElectricAmplifierLabel" style="padding-left: 0" disabled><input class="allowNeuroElectricAmplifierInput" type="checkbox" disabled />@Lo["Can build {0}",YLo["building_neuro_electric_amplifier"]]</label>
						}


						<button>@Lo["Find best tile for colony capital"]</button>

						<div class="result-display"></div>
					</div>
				</div>
			</div>
		</fieldset>
	</div>
	<fieldset id="queryPlanet">
		<legend>@Lo["Query a planet"]</legend>
		<div>
			<label>@Lo["Planet ID"] <input id="planetIdInput" type="number" /></label>
			<button id="queryPlanetButton" type="submit">Submit</button>
		</div>
	</fieldset>
</div>


@section Scripts
{
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
	<script src="~/content/planets.js"></script>
	<script type="text/javascript">
		'use strict';

		document.planetsData = {}; //不用关键字var可成为全局变量，但这在严格模式不允许。

		document.saveGamePath = "@Model.LatestSaveGamesPath.Replace('\\', '/')";
		if (document.saveGamePath)
		{
			fetch(`/api/${document.saveGamePath}/Countries/me/Planets`).then(response => response.json()).then(planetsData =>
			{
				document.planetsData = planetsData;


				let $template = $("#planetSectionTemplate");

				planetsData.forEach((planet, index) =>
				{
					let $section = $template.clone();
					$section.removeAttr("id");
					buildPlanetSection($section, planet, index);
					$("#planets").append($section);
				});
			});
		} else
			$("body").text("No save games!");


		function buildPlanetSection($section, planet, index)
		{
			$section.attr("index", index);

			$section.find("legend").text(planet.Name);

			buildTilesTable($section.find(".tiles"), planet.Tiles);

			let $form = $section.find(".best-colony");
			let $button = $form.find("button");
			$button.click(bestColonyButton_Click);
			if (@Model.IsMachineEmpire.ToString().ToLower())
			{
				$form.find("select").change(function()
				{
					let v = parseInt($(this).val());
					let $label = $(this).closest(".best-colony").find(".allowNeuroElectricAmplifierInput").closest("label");
					if (v < 2)
					{
						$label[0].setAttribute("disabled", "");
						$label.find("input")[0].setAttribute("disabled", "");
					} else
					{
						$label[0].removeAttribute("disabled");
						$label.find("input")[0].removeAttribute("disabled");
					}
				});
			}

			let s = localStorage.getItem("planet-capital-options");
			if (s)
			{
				try
				{
					let options = JSON.parse(s);
					$form.find(".adjacency-bonus-input").val(options.adjacencyBonus);
					$form.find(".not-on-special-input")[0].checked = options.notOnSpecial;
					@if (Model.IsMachineEmpire)
					{
						@:$form.find(".allowNeuroElectricAmplifierInput")[0].checked = options.allowNeuroElectricAmplifier;
					}
				} catch (e)
				{
					localStorage.removeItem("planet-capital-options");
				}
			}
		}

		function bestColonyButton_Click()
		{
			let $section = $(this).closest(".planet");
			let $form = $(this).closest(".best-colony");
			let $resultDisplay = $form.find(".result-display");
			$resultDisplay.empty();
			$section.find("table.tiles td").removeClass("bg-highlight");


			let planet = $section.attr("index") === "query" ? document.queriedPlanet : document.planetsData[parseInt($section.attr("index"))];
			let options = {
				adjacencyBonus: parseInt($form.find(".adjacency-bonus-input").val()),
				notOnSpecial: $form.find(".not-on-special-input")[0].checked,
				@if (Model.IsMachineEmpire)
				{
					@:allowNeuroElectricAmplifier: $form.find(".allowNeuroElectricAmplifierInput")[0].checked
				}
			};

			localStorage.setItem("planet-capital-options", JSON.stringify(options));


			let result = findBestTileForColonyCapital(planet.Tiles, options);
			let maxBonus = result[0].bonus;
			//并列第一的都列出来
			for (let i = 0; i < result.length && (i < 3 || result[i].bonus === maxBonus); i++)
			{
				$resultDisplay.append(`<p>都城建在<span class="tileId ${result[i].bonus === maxBonus ? "bg-highlight" : ""}" >${result[i].capitalTileId}</span>，加成为${result[i].bonus}${result[i].conditions}</p>`);
				if (result[i].bonus === maxBonus)
					findTileTd.call($section, result[i].capitalTileId).addClass("bg-highlight");
			}

			$form.find(".tileId").hover(function()
			{
				let $this = $(this);
				findTileTd.call($this, parseInt($this.text())).addClass("bg-active");
			}, function()
			{
				let $this = $(this);
				findTileTd.call($this, parseInt($this.text())).removeClass("bg-active");
			});
		};

		function buildTilesTable($planetTable, tiles)
		{
			let id = 0;
			//let planetSize = Object.keys(tiles).length;
			//outside:

			for (let row = 0; row < 5; row++)
			{
				let $tr = $("<tr>");
				for (let column = 0; column < 5; column++)
				{
					let $td = $("<td>");
					if (tiles[id])
					{
						let technologies = 0;
						let special = 0;
						for (let [resourceName, amount] of Object.entries(tiles[id].Resources))
						{
							switch (resourceName)
							{
							case "minerals":
								$td.append(`<span class="resource"><img src="https://stellaris.paradoxwikis.com/images/1/10/Minerals.png" title="@YLo["minerals"]">${amount}</span>`);
								break;
							case "energy":
								$td.append(`<span class="resource"><img src="https://stellaris.paradoxwikis.com/images/5/58/Energy_Credits.png" title="@YLo["energy"]">${amount}</span>`);
								break;
							case "food":
								$td.append(`<span class="resource"><img src="https://stellaris.paradoxwikis.com/images/c/c6/Food.png" title="@YLo["food"]">${amount}</span>`);
								break;
							case "research":
								technologies += amount;
								break;
							default:
								special += amount;
							}
						}
						if (technologies > 0)
							$td.append(`<span class="resource"><img src="https://stellaris.paradoxwikis.com/images/2/20/Research.png" width=22 title="@YLo["RESEARCH"]">${technologies}</span>`);
						if (special > 0)
							$td.append(`<span class="resource"><img src="https://stellaris.paradoxwikis.com/images/8/83/Strategic.png" title="@Lo["Special Resources, eg. alien pets, betharian"]">${special}</span>`);
					} else
						$td.addClass("nonexistent");
					$tr.append($td);
					id++;
				}
				$planetTable.append($tr);
				//if (id > planetSize)
				//	break outside;
			}
		};

		function findBestTileForColonyCapital(tiles, options)
		{
			let id = -1;
			let list = [];
			for (let row = 0; row < 5; row++)
			{
				for (let column = 0; column < 5; column++)
				{
					id++;
					if (tiles[id])
					{
						if (options.notOnSpecial && tiles[id].Resources.special)
							continue;

						let r = getTotalBonus(tiles, id, options);
						r.capitalTileId = id;
						list.push(r);
					}
				}
			}

			list.sort((a, b) => b.bonus - a.bonus);
			return list;
		}

		function getTotalBonus(tiles, capitalTileId, options)
		{
			options.ignoreFood = @Model.IsMachineEmpire.ToString().ToLower();


			let id = 0;
			let bonus = 0;
			let conditions = '';
			for (let row = 0; row < 5; row++)
			{
				for (let column = 0; column < 5; column++)
				{
					if (tiles[id])
					{
						let res = Object.assign({}, tiles[id].Resources);
						//行星都城本格只能产电
						if (id === capitalTileId)
						{
							if (options.notOnSpecial && res.special)
								continue;

							delete res.energy;
							if (options.ignoreFood)
								delete res.food;

							//除电以外的资源都被压了，减成
							Object.keys(res).forEach(k => bonus -= res[k]);
						} else if (isTileAdjacent(id, capitalTileId))
						{
							if (res.energy > 0 || res.minerals > 0 || (!options.ignoreFood && res.food > 0))
							{
								bonus += options.adjacencyBonus;
								if (res.research || res.special)
								{
									conditions += `; 假设地块<span class="tileId">${id}</span>造基本建筑`;
									if (res.research)
										conditions += `，${res.resource}点科研被压`;
									if (res.special)
										conditions += "，特殊资源被压";
								}
							} else if (res.research)
							{
								//不覆盖科研点
							} else
							{
								if (options.ignoreFood && res.food > 0)
									conditions += `; 假设食物地块<span class="tileId">${id}</span>造基本建筑`;
								else
									conditions += `; 假设空地块<span class="tileId">${id}</span>造基本建筑`;
								bonus += options.adjacencyBonus;
							}
						}
					}
					id++;
				}
			}
			return { bonus: bonus, conditions: conditions /*.substr(2)*/ };
		}
		
	</script>
	<script>
		$("#queryPlanetButton").click(function()
		{
			let thisButton = this;
			thisButton.disabled = true;

			$("#queryPlanetDynamicSection").detach();

			fetch(`/api/${document.saveGamePath}/Planets/${$("#planetIdInput").val()}`).then(response => response.json()).then(planetTiles =>
			{
				document.queriedPlanet = planetTiles;

				let $section = $("#planetSectionTemplate").clone();
				$section.attr("id", "queryPlanetDynamicSection");
				buildPlanetSection($section, planetTiles, "query");
				$("#queryPlanet").append($section);
				thisButton.disabled = false;
			}).catch(function(reason)
			{
				thisButton.disabled = false;
				alert(reason);
			});
		});
	</script>
}