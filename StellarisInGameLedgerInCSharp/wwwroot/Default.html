<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
    <script type="text/javascript">
        const countriesPromise = fetch("/api/Countries");

        // Load the Visualization API and the corechart package.
        google.charts.load('current', { 'packages': ['table'] });

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(drawTable);


        function getColumnHeader(name) {
            switch (name) {
                case "technologyCount":
                    return "Technologies";
                case "colonyCount":
                    return '<img src="https://stellaris.paradoxwikis.com/images/6/6e/Planet_gaia.png" title="Colonies">';
                case "energy":
                    return '<img src="https://stellaris.paradoxwikis.com/images/5/58/Energy_Credits.png" title="Energy">';
                case "energyIncome":
                    return '<img src="https://stellaris.paradoxwikis.com/images/5/58/Energy_Credits.png" title="Energy"> Income';
                case "minerals":
                    return '<img src="https://stellaris.paradoxwikis.com/images/1/10/Minerals.png" title="Minerals">';
                case "mineralsIncome":
                    return '<img src="https://stellaris.paradoxwikis.com/images/1/10/Minerals.png" title="Minerals"> Income';
                case "food":
                    return '<img src="https://stellaris.paradoxwikis.com/images/c/c6/Food.png" title="Food">';
                case "foodIncome":
                    return '<img src="https://stellaris.paradoxwikis.com/images/c/c6/Food.png" title="Food"> Income';
                case "influence":
                    return '<img src="https://stellaris.paradoxwikis.com/images/9/91/Influence.png" title="Influence">';
                case "influenceIncome":
                    return '<img src="https://stellaris.paradoxwikis.com/images/9/91/Influence.png" title="Influence"> Income';
                case "unity":
                    return '<img src="https://stellaris.paradoxwikis.com/images/3/3d/Unity.png" title="Unity">';
                case "unityIncome":
                    return '<img src="https://stellaris.paradoxwikis.com/images/3/3d/Unity.png" title="Unity"> Income';
                case "physicsResearchIncomeWithPenalty":
                    return '<img src="https://stellaris.paradoxwikis.com/images/b/b3/Research_speed_%28Physics%29.png" title="Physics Income with Penalty">';
                case "societyResearchIncomeWithPenalty":
                    return '<img src="https://stellaris.paradoxwikis.com/images/4/4f/Research_speed_%28Society%29.png" title="Society Income with Penalty">';
                case "engineeringResearchIncomeWithPenalty":
                    return '<img src="https://stellaris.paradoxwikis.com/images/e/ec/Research_speed_%28Engineering%29.png" title="Engineering Income with Penalty">';
                case "population":
                    return '<img src="https://stellaris.paradoxwikis.com/images/7/71/Pop.png" title="Population">';

                default:
            }


            return _.startCase(name);
        }

        function formatCellValue(value) {
            if (_.isInteger(value))
                return value.toFixed(0);
            else if (_.isNumber(value)) {
                if (value > 0)
                    return `<span class="positive">${value.toFixed(2)}</span>`;
                else
                    return `<span class="negative">${value.toFixed(2)}</span>`;
            }
            else
                return value;
        }


        function drawTable()
        {
            countriesPromise.then(response => response.json()).then(countries =>
            {
                drawTableFromJson(countries, document.getElementById('table_div'));
            });
        }

        /**
         *
         * @param {Array} countries
         * @param {HTMLElement} placeHolder
         */
        function drawTableFromJson(countries, placeHolder)
        {
            countries.forEach(item =>
            {
                Object.defineProperty(item, 'totalResearchIncomeWithPenalty',
                    {
                            get: function() {
                            return this.physicsResearchIncomeWithPenalty + this.societyResearchIncomeWithPenalty + this.engineeringResearchIncomeWithPenalty;
                        }
                    });

            });

            const data = new google.visualization.DataTable();
            let propertyNames = Object.getOwnPropertyNames(countries[0]);

            propertyNames = propertyNames.filter(p => ["physicsResearchIncome", "societyResearchIncome", "engineeringResearchIncome"].indexOf(p) === -1);

            propertyNames.forEach(p =>
            {
                data.addColumn({ type: typeof (countries[0][p]), label: getColumnHeader(p) });
            });


            const rows = countries.map(item =>
            {
                    const cells = propertyNames.map(p => {
                    return { v: item[p], f: formatCellValue(item[p]) };
                });
                return cells;
            });



            data.addRows(rows);

            const view = new google.visualization.DataView(data);
            var columns = view.getViewColumns();
            //columns.push({
            //    calc: (dataTable, rowIndex) => {
            //        var row = dataTable[rowIndex];
            //    },
            //    type: "number"
            //});
            //view.setColumns(columns);

            // Instantiate and draw our chart, passing in some options.
            const table = new google.visualization.Table(placeHolder);

            table.draw(view, { allowHtml: true });

        }
    </script>

    <style type="text/css">
        thead th img {
            max-height: 32px;
        }

        .negative {
            color: red;
        }
    </style>
</head>

<body>
    <!--Div that will hold the pie chart-->
    <div id="table_div"></div>


    <script>
        fetch("/api/RecentSaves").then(response => response.json()).then(recentSaves =>
        {
            recentSaves.splice(0, 1);
            recentSaves.forEach(path =>
            {
                path = path.replace("\\", "/");

                fetch(`/api/${path}/Countries`).then(r => r.json()).then(countries =>
                {
                    let div = document.createElement("div");
                    let body = document.getElementsByTagName("body")[0];
                    body.appendChild(div);

                    drawTableFromJson(countries, div);
                });
            });
        });
    </script>
</body>
</html>
