<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Stellaris Ledger</title>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.0/lodash.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>


    <style type="text/css">
        thead th img {
            max-height: 32px;
            vertical-align: middle;
        }

        .negative {
            color: red;
        }

        #visibleColumnsForTable label {
            float: left; /* 不用display:block因为这样会使label占据大量空间，光标点击空白区会意外勾选多选框。 */
            clear: left;
        }

        label {
            padding-right: 3em;
        }
    </style>
</head>

<body>
    <!--Div that will hold the pie chart-->
    <div id="table_div"></div>


    <fieldset>
        <legend>Show following columns</legend>
        <div id="visibleColumnsForTable"></div>
    </fieldset>
    <script type="text/javascript">
        "use strict";

        let googleTable;
        let tableData;


        // Load the Visualization API and the corechart package.
        google.charts.load('current', { 'packages': ['corechart', 'table'] });

        function getColumnHeader(name)
        {
            name = _.startCase(name).replace(/\bWith\b/, "with");

            switch (name)
            {
                case "Technology Count":
                    return "Technologies";
                case "Colony Count":
                    return '<img src="https://stellaris.paradoxwikis.com/images/6/6e/Planet_gaia.png" title="Colonies">';
                case "Tradition Count":
                    return "Traditions";
            }

            name = name.replace("Energy", '<img src="https://stellaris.paradoxwikis.com/images/5/58/Energy_Credits.png" title="Energy">')
                .replace("Minerals", '<img src="https://stellaris.paradoxwikis.com/images/1/10/Minerals.png" title="Minerals">')
                .replace("Food", '<img src="https://stellaris.paradoxwikis.com/images/c/c6/Food.png" title="Food">')
                .replace("Influence", '<img src="https://stellaris.paradoxwikis.com/images/9/91/Influence.png" title="Influence">')
                .replace("Unity", '<img src="https://stellaris.paradoxwikis.com/images/3/3d/Unity.png" title="Unity">')
                .replace("Physics Research Income with Penalty", '<img src="https://stellaris.paradoxwikis.com/images/b/b3/Research_speed_%28Physics%29.png" title="Physics Income with Penalty">')
                .replace("Society Research Income with Penalty", '<img src="https://stellaris.paradoxwikis.com/images/4/4f/Research_speed_%28Society%29.png" title="Society Income with Penalty">')
                .replace("Engineering Research Income with Penalty", '<img src="https://stellaris.paradoxwikis.com/images/e/ec/Research_speed_%28Engineering%29.png" title="Engineering Income with Penalty">')
                .replace("Population", '<img src="https://stellaris.paradoxwikis.com/images/7/71/Pop.png" title="Population">')
                .replace("Total Research Income with Penalty","<span title='Total Research Income with Penalty'><img src='https://stellaris.paradoxwikis.com/images/b/b3/Research_speed_%28Physics%29.png'> + <img src='https://stellaris.paradoxwikis.com/images/4/4f/Research_speed_%28Society%29.png'> + <img src='https://stellaris.paradoxwikis.com/images/e/ec/Research_speed_%28Engineering%29.png'></span>");

            return name;
        }


        /**
         *
         * @param value
         * @returns undefined 如果value可以原样显示
         */
        function formatCellText(value, propertyName)
        {
            if (propertyName === "unityIncomeWithPenalty")
                return "≈" + value.toFixed(3);


            if (_.isInteger(value))
                return value.toFixed(0);
            else if (_.isNumber(value))
            {
                if (value > 0)
                    return `<span class="positive">${value.toFixed(2)}</span>`;
                else
                    return `<span class="negative">${value.toFixed(2)}</span>`;
            }
            else
                return undefined;
        }

        function addCalculatedProperties(country)
        {
            Object.defineProperty(country, 'totalResearchIncomeWithPenalty',
                {
                    get: function ()
                    {
                        return this.physicsResearchIncomeWithPenalty + this.societyResearchIncomeWithPenalty + this.engineeringResearchIncomeWithPenalty;
                    }
                });
        }

        function getDefaultColumnVisibility(columnName)
        {
            if (["physicsResearchIncome", "societyResearchIncome", "engineeringResearchIncome"].indexOf(columnName) == -1)
                return true;
            else
                return false;
        }

        /**
         *
         * @param {Array} countries
         * @param {HTMLElement} placeHolder
         */
        function drawTableFromJson(countries)
        {

            tableData = new google.visualization.DataTable();
            let propertyNames = Object.getOwnPropertyNames(countries[0]);

            //propertyNames = propertyNames.filter(p => ["physicsResearchIncome", "societyResearchIncome", "engineeringResearchIncome"].indexOf(p) === -1);

            propertyNames.forEach(p => tableData.addColumn({ type: typeof (countries[0][p]), label: getColumnHeader(p) }));

            //创建多选框控制列的显隐
            propertyNames.forEach((p, i) =>
            {
                const checkBox = $("<input type='checkbox'>");
                checkBox.attr("name", i);
                checkBox.change(function ()
                {
                    localStorage.setItem("table-" + $(this).attr("name"), $(this).prop("checked"));
                    updateTableView();
                });

                let isChecked = localStorage.getItem("table-" + i);
                if (isChecked == undefined)
                    isChecked = getDefaultColumnVisibility(p);
                else
                    isChecked = isChecked == "true";
                checkBox.prop("checked", isChecked);
                const label = $(`<label>${_.startCase(p).replace(/\bWith\b/, "with")}</label>`);
                label.prepend(checkBox);
                $("#visibleColumnsForTable").append(label);
            });

            let maxLabelWidth = 0;
            $("#visibleColumnsForTable label").each(function ()
            {
                let w = $(this).outerWidth();
                if (w > maxLabelWidth)
                    maxLabelWidth = w;
            });
            $("#visibleColumnsForTable").css("column-width", `${maxLabelWidth}px`);


            const rows = countries.map(item =>
            {
                return propertyNames.map(p =>
                {
                    const f = formatCellText(item[p],p);
                    return f ? { v: item[p], f: f } : item[p];
                });
            });



            tableData.addRows(rows);


            updateTableView();
        }

        function updateTableView()
        {
            const view = new google.visualization.DataView(tableData);
            var columns = view.getViewColumns();
            columns = columns.filter(c => $(`#visibleColumnsForTable input[name="${c}"]`).prop("checked"));
            view.setColumns(columns);

            // Instantiate and draw our chart, passing in some options.
            googleTable = new google.visualization.Table(document.getElementById('table_div'));

            googleTable.draw(view, { allowHtml: true, width:"100%" });
        }
    </script>

    <div id="historyPanel">
        <div id="countryFilterPanel"></div>
    </div>
    <script>
        let historyData;
        let tags = [];

        google.charts.setOnLoadCallback(() =>
        {
            fetch("/api/RecentSaves").then(response => response.json()).then(recentSaves =>
            {
                if (recentSaves.length === 0)
                {
                    $("body").html("No savegames");
                    return;
                }

                //recentSaves.splice(0, 1);
                const promises = recentSaves.map(path => fetch(`/api/${path.replace("\\", "/")}/Countries`).then(r =>
                {
                    const i = path.indexOf("\\") + 1;
                    //定义一个新的承诺，当r.json()承诺实现时，新的承诺也实现。
                    return new Promise(function (resolve, reject)
                    {
                        r.json().then(json =>
                        {
                            json.forEach(addCalculatedProperties);

                            resolve({
                                date: path.substr(i, path.length - i - ".sav".length),
                                content: json
                            });
                        });
                    });
                }));

                promises[0].then(data =>
                {
                    drawTableFromJson(data.content);
                });

                Promise.all(promises).then(history =>
                {
                    history = history.sort((x, y) => Date.parse(x.date) - Date.parse(y.date));
                    historyData = history;


                    for (let snapshot of history)
                    {
                        for (let country of snapshot.content)
                            tags.push(country.tag);
                    }
                    tags = jQuery.uniqueSort(tags);
                    tags = tags.map(tag =>
                    {
                        for (let i = history.length - 1; i >= 0; i--)
                        {
                            for (let country of history[i].content)
                            {
                                if (country.tag === tag)
                                    return { tag: tag, name: country.name };
                            }
                        }
                        throw new Error();
                    });

                    const filterPanel = $("#countryFilterPanel");
                    for (let tag of tags)
                    {
                        const label= $(`<label>${tag.name}</label>`);
                        const checkBox = $(`<input type='checkbox' name='${tag.name}'>`);

                        let v = localStorage.getItem("history-" + tag.name);
                        if (v == undefined)
                            v = true;
                        else
                            v = v == "true";
                        checkBox.prop("checked", v);

                        checkBox.change(function ()
                        {
                            localStorage.setItem("history-" + $(this).attr("name"), $(this).prop("checked"));
                            updateHistoryCharts();
                        });

                        label.prepend(checkBox);
                        filterPanel.append(label);
                    }

                    updateHistoryCharts();
                });
            });
        });


        function updateHistoryCharts()
        {
            let propertyNames = Object.getOwnPropertyNames(historyData[0].content[0]);
            for (let property of propertyNames.filter(p => ["tag", "name"].indexOf(p) === -1))
            {
                const lineChartData = new google.visualization.DataTable();
                lineChartData.addColumn({ type: "date", label: "date" });
                for (let tag of tags)
                    lineChartData.addColumn({ type: "number", label: tag.name });

                const rows = historyData.map(item =>
                {
                    const row = [new Date(Date.parse(item.date))];
                    for (let tag of tags)
                    {
                        const country = item.content.find(c => c.tag === tag.tag);
                        if (country)
                        {
                            row.push(country[property]);
                        } else
                            row.push(undefined);
                    }
                    return row;
                });

                lineChartData.addRows(rows);


                var dateFormatter = new google.visualization.DateFormat({ pattern: "yyyy.MM.dd" });
                dateFormatter.format(lineChartData, 0);

                var options = {
                    title: _.startCase(property).replace(/\bWith\b/, "with"),
                    legend: { position: 'right' },
                    width: document.getElementsByTagName("body")[0].clientWidth - 50,
                    height: Math.max(400, 100 * Math.ceil(tags.length / 2.0)),
                    pointSize: 5,
                };

                let chartDiv = $(`#${property}Chart`);
                if (chartDiv.length === 0)
                {
                    chartDiv = $(`<div id="${property}Chart"></div>`);
                    $("#historyPanel").append(chartDiv);
                }

                const view = new google.visualization.DataView(lineChartData);
                var columns = view.getViewColumns();
                columns = columns.filter(columnIndex => columnIndex===0 || $(`#countryFilterPanel input[name="${view.getColumnLabel(columnIndex)}"]`).prop("checked"));
                view.setColumns(columns);


                const googleLineChart = new google.visualization.LineChart(chartDiv[0]);

                googleLineChart.draw(view, options);
            }
        }
    </script>
</body>
</html>
